name: Terragrunt Workflow

on:
  pull_request:
    branches:
      - main

jobs:
  terragrunt:
    name: Terragrunt Matrix
    runs-on: ubuntu-latest

    strategy:
      matrix:
        environment: [dev, prod]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.0.0

    - name: Install Terragrunt
      run: |
        sudo wget -q -O /bin/terragrunt "https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.17/terragrunt_linux_amd64"
        sudo chmod +x /bin/terragrunt
        terragrunt -v

    - name: Format Terraform code
      run: |
        hclfmt --terragrunt-check --terragrunt-diff

    - name: Plan Terraform changes
      id: plan
      run: |
        terragrunt plan -out=tfplan -input=false -lock=false -var "environment=${{ matrix.environment }}"
      continue-on-error: true

    - name: Comment PR with Terraform plan
      if: always()
      run: |
        echo "Terraform plan for environment: ${{ matrix.environment }}" >> comment.txt
        echo "----------------" >> comment.txt
        cat tfplan >> comment.txt
        echo "" >> comment.txt
        echo "For detailed changes, check the logs." >> comment.txt
        echo "::set-output name=comment::$(cat comment.txt)"

   